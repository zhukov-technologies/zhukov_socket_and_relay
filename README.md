# ВНИМАНИЕ! Данный проект ныне считается устаревшим. Описание актуальных версий будет дополнено в репозиториях [профиля](https://github.com/zhukov-technologies).


# Умная розетка и умное реле zhukov technologies
Розетка и реле - устройства системы умного дома на основе API Telegram.

![DSC06524](https://user-images.githubusercontent.com/84660518/156652191-d5a9511f-c55e-4593-9be8-8c6b3b57945d.jpg)
![DSC06530](https://user-images.githubusercontent.com/84660518/156652329-725f3acb-2d90-4d71-899d-be960b87dbc5.jpg)

## Содержание
- [Умная розетка и умное реле zhukov technologies](#socket)
- [Подробнее о системе и коде](#code)
- [Плата и основные компоненты](#components)
- [Схема и работа печатной платы](#scheme)
- [Запуск и настройка](#usage)
- - [Создание бота в Telegram](#bot)
- - [Настройка розетки и реле в режим шлюза](#socket_setup)
- [Обновление прошивки](#update)
- [Ответственность](#responsibility)
- [Контакты](#contacts)


<a id="socket"></a>
# Умная розетка и умное реле zhukov technologies

Розетка и реле управляются с помощью c помощью [выключателя](https://github.com/zhukov-technologies/zhukov_switch), а также шлюза - таких же розеток и реле, настроенных в режиме шлюза.

Розетка или реле, настроенные как шлюз, взаимодействуют c API Telegram, позволяя пользователю отправлять команды и предоставляет на них ответ в Telegram-боте, заренее созданном пользователем. 

Шлюз подключается к Интернету через WI-Fi и взаимодействует с Telegram ботом, получая команды от него, обрабатывает их и управляет другими розетками и реле с помощью технологии [ESP-NOW.](https://www.espressif.com/en/products/software/esp-now/overview)

Возможности шлюза:

* соединение с точкой доступа Wi-Fi и выход в интернет,
* обмен данными с другими устройствами умного дома с применением технологии [ESP-NOW](https://www.espressif.com/en/products/software/esp-now/overview),


<a id="code"></a>
# Подробнее о системе и коде
Здесь и далее находится описание реле и розетки. Информацию о системе умного дома, особенностях кода прошивки вы можете найти [здесь](https://github.com/zhukov-technologies/zhukov_socket_and_relay/blob/main/ABOUT.md).

<a id="components"></a>
# Плата и основные компоненты

![Безымянный2](https://user-images.githubusercontent.com/84660518/156656077-4f18c050-68e5-47ef-8cb8-3649ebe82644.png)

Основные компоненты:
 * микроконтроллер Espressif ESP-12F,
 * реле Т73 5VDC,
 * блок питания,
 * кнопка.

<a id="scheme"></a>
# Схема и работа печатной платы
![Schematic_relay v2_2022-03-04](https://user-images.githubusercontent.com/84660518/156656594-a3edc0f4-5103-4742-ace6-3b302aa78984.png)


На плату подаётся питание 5 В от блока питания, подключенного через изоляционную прокладку. Так как микроконтроллеру ESP-12F требуется питание 3.3 В, предусмотрен блок стабилизации напряжения — непосредственно сам стабилизатор AMS1117-3.3, а также входные и выходные сглаживающие конденсаторы для обеспечения стабильности работы платы. 

Для корректной работы реле, в отличие от ESP-12f, требуется 5 В, поэтому на плате предусмотрен транзистор MMBT2222A, позволяющий управлять обмоткой реле. 

Также в схему включена тактовая кнопка для удобства аналогового управления а также поддержки возможности управления реле или розеткой при отсутствии соединения с интернетом.

<a id="usage"></a>
# Запуск и настройка


<a id="bot"></a>
## Создание бота в Telegram

Чтобы управлять системой умного дома zhukov technologies с помощью шлюза в виде розетки или реле, необходимо создать собственного бота в Telegram. 

Для этого необходимо: 

1. Открыть диалог с [BotFather](https://t.me/BotFather). Это главный бот - он создаёт ботов. Нажать старт, а после его ответа ввести команду /newbot.
2. Придумать любое название (name) для бота, например 'Мой дом' или 'Квартира 50'.
3. Придумать имя бота (username). Оно должно оканчиваться на '_bot'.
Стоит обратить внимание, имя должно быть уникальное и написано на латинице! 

![bot_setup_photo](https://sun9-16.userapi.com/impg/-nRxiS5cMcZzMEwY4AHRpcTjz620_PIXO3lhCQ/SQggVuj7LbE.jpg?size=643x708&quality=96&sign=7c06548da13f7d55b5b9700b7de150ec&type=album)

После завершения процедуры создания бота, необходимо сохранить выделенные данные — ссылку на бота и токен.

Внимание! Токен обязательно нужно хранить в тайне, так как с помощью него предоставляется доступ к боту.

<a id="socket_setup"></a>
## Настройка розетки и реле в режим шлюза

Когда бот создан, можно приступить к настройке розетки или реле в режим шлюза. 

Для этого необходимо: 

1. Включить розетку или реле, зажав при этом единственную кнопку. Розетка войдет в нужный режим, затем нужно подключиться с телефона, планшета или компьютера к Wi-Fi сети socket с паролем iloveyou.
2. Зайти в браузер по адресу http://10.10.10.10 и ввести точку доступа своего домашнего Wi-Fi, пароль и токен созданного бота в предложенную форму. Также в форме можно указать название данной розетки-шлюза, и в какую группу она будет помещена - устройство освещения или розетка.

![socket captive](https://user-images.githubusercontent.com/84660518/177988180-76cb5e63-52dc-4295-b2ac-93f6bd7b75bd.PNG)

После всех процедур в течении нескольких секунд розетка соединится с сетью и станет доступен весь её функционал.

Возможности системы умного дома
- [X] Управление розетками и реле с получением ответа о состоянии
- [X] Добавление и удаление из списка розеток и реле
- [X] Возможность переименовать добавленное устройство
- [X] Возможность настраивать (связывать) выключатель с розеткой и реле
- [X] Возможность делегировать другим пользователям права на управление системой
- [X] Автоматическое обновление прошивки

Линейка устройств будет расширяться, возможности системы будут дополняться. 


<a id="update"></a>
# Обновление прошивки

Данный код предполагает развитие системы, совершенствование и создание новых устройств, поэтому в реле и розетках а также в других устройствах zhukov technologies предусмотрена функция обновления прошивки: раз в 12 часов устройство пытается связаться с сервером, где находится файл со следующей версией прошивки.
При отсутствии файла, следующий запрос происходит через 12 часов. Если на сервере присутствует запрашиваемый файл — прошивка обновляется. 

Данная возможность реализована с помощью встроенной в SDK библиотеки ESP8266httpUpdate.

В функции обновления сначала создаётся клиент:
```cpp
WiFiClient client;
```

затем объявляются callback функции:
```cpp
ESPhttpUpdate.onStart(update_started);
ESPhttpUpdate.onEnd(update_finished);
ESPhttpUpdate.onProgress(update_progress);
ESPhttpUpdate.onError(update_error);
```

и непосредственно сама строчка, отвечающая за связь с сервером и обновление прошивки:
```cpp
t_httpUpdate_return ret = ESPhttpUpdate.update(client, "http://www.myserver.ru/socket_v2.bin");
```

Функция обновления прошивки справляется с некоторыми внештатными ситуациями и не вызывает поломок и "окирпичивания" модуля: при внезапном отключении питания, обрыве связи с сервером и прочими проблемами прошивка приостанавливается и возобновляется при восстановлении подключения или подключении питания.


<a id="responsibility"></a>
# Ответственность

В прошивке розетки и реле используются библиотеки из проектов с открытым исходным кодом на основании лицензий, закреплёнными за авторами библиотек. Таким образом, работоспособность библиотек не может быть гарантирована. Также нет никаких гарантий, что устройство будет работать с вашей электросетью, и вы не получите ущерба во время эксплуатации устройства.

[Лицензия GNU General Public License v3.0](https://github.com/zhukov-technologies/zhukov_socket_and_relay/blob/main/LICENSE.md)

<a id="contacts"></a>
# Контакты

https://zhukov-tech.ru


